## 业务背景

现有一音频标注系统（标注结果用于语音模型训练），该系统有 n 个数据集，每个数据集包含 m 个上传记录，每个上传记录有大约 50 万条音频文件用于标注。为了提高标注人员的标注效率，该系统新增了一个“预标注”的功能。该功能的作用就是在每次上传一条上传记录之后，对上传记录中的所有音频进行预标注，这样后续标注人员在拿到音频时，不必花时间去等待音频标注，而是直接在标注完成的音频上进行校准。标注人员通过基于数据集创建的标注任务进行音频标注。如果该数据集下某个上传记录中的音频正在被预标注，那么无法从该数据集创建标注任务。

## 业务需求

### 需求一

在新建上传记录之后，上传记录中的所有音频都需要发送给识别服务进行预标注

### 需求二

上传记录在进行预标注时，该上传记录所属数据集无法创建标注任务。上传记录中**所有**音频完成预标注之后，该上传记录所属数据集才可以创建标注任务

## 业务实现

### 总体实现概览

![预标注业务.png](https://obsidian-1312372886.cos.ap-shanghai.myqcloud.com/%E9%A2%84%E6%A0%87%E6%B3%A8%E4%B8%9A%E5%8A%A1.png)

上图是整个预标注业务的整体流程概览。标注系统是基于 Java 的 web 服务，识别服务是基于C语言的ASR服务。

### [[音频预标注业务实现思路#需求一|需求一]]实现

新建上传记录之后，标注系统遍历上传记录中的每一条音频，将该音频相关信息发送到消息队列，以供后续识别服务进行预标注。

识别服务从消息队列中消费音频信息，对音频进行预标注，最后将音频预标注结果发送给消息队列。

标注系统从消息队列消费音频预标注结果并持久化。

### [[音频预标注业务实现思路#需求二|需求二]]实现

给数据集表新增一个字段用于判断是否可以从该数据库创建新的标注任务，在新建上传记录之后，将该字段设置为”否“，在上传记录中所有音频都被预标注完成之后，再将该字段设置为”是“。

#### 问题一

由于整个预标注流程是异步进行的，如何判断整个上传记录中的音频都完成预标注？可以在标注系统获取预标注结果时，对比总的音频数量和已经完成预标注的音频数量，如果总的音频数量=已经完成预标注的音频数量 + 1（当前音频），那么就将数据集设置为可以创建标注任务。

理想情况下，解决完问题一之后，整个音频预标注业务就算实现了。但是实际环境往往是复杂的，由于需求二的实现需要一条消息都不能丢失，无论是标注系统发送消息经由消息队列给识别服务还是识别服务发送消息经由消息队列给标注系统，考虑到会出现系统服务重启、升级或者崩溃不可用等各种情况，我们需要额外的重试机制来保证每一条音频都完成预标注。由此，引申出了问题二。

#### 问题二

一条音频的完整预标注流程包含四个步骤：

1. 标注系统发送音频消息到消息队列
2. 识别服务读取音频消息并进行预标注
3. 识别服务发送音频标注消息到消息队列
4. 标注系统读取音频预标注消息并持久化  

以上四个步骤中任何一个步骤出问题都会导致最终音频预标注完成数量和音频总数量对不上，进而导致整个数据集无法新建标注任务。举个例子，在极端情况下，一个上传记录中有 50 万条音频，其中某一条音频的预标注流程出了问题，即使 499999 条都已经完成预标注，整个数据集还是无法新建标注任务。为了解决这个问题，我们需要确保四个步骤中的每一步都稳定可靠。

##### 步骤 1

标注系统遍历上传记录中的所有音频，发送音频信息到消息队列。在这个过程中，可能存在两个问题。

第一个问题，如何确保消息成功发送给消息队列？解决这个问题可以使用消息队列的同步发送方式，消息成功发送给消息队列之后，消息队列会返回一个状态码，通过状态码可以确认标注系统是否成功将消息发送给消息队列。

第二个问题，在发送音频信息消息的过程中，标注系统由于各种原因不可用，导致消息发送进程中断，如何保存以及恢复这种中间状态（已发送的消息不需要重复发送，未发送的消息需要继续发送）？笔者预想的解决方案是，使用支持从持久化恢复的定时任务，如 xxl-job 来处理步骤 1。

![仅步骤一.png](https://obsidian-1312372886.cos.ap-shanghai.myqcloud.com/%E4%BB%85%E6%AD%A5%E9%AA%A4%E4%B8%80.png)
